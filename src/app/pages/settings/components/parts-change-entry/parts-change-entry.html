<div class="container-xxl p-3 my-4 bg-white shadow-sm rounded-2 border">
    <div class="table-responsive">
        <table class="table caption-top table-striped table-hover">
            <caption>
                <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
                    <div class="d-flex align-items-center gap-2 column-gap-3">
                        <strong class="text-capitialise fs-5">
                            Machine Parts
                        </strong>
                        <app-entries-per-page-selector [pageSize]="pageSize" selectClass="form-select-sm"
                            (pageSizeChange)="onEntriesPerPageChange($event)" />
                    </div>
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <!-- filter button -->
                        <button class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-1"
                            (click)="onOpenFilterPopup()">
                            <svg height="18" width="18" viewBox="0 0 48 48" class="flex-shrink-0">
                                <polygon fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="4"
                                    points="6,10 42,10 28,26 28,38 20,42 20,26 " />
                            </svg>
                            <span class="text-nowrap">
                                Filters
                            </span>
                        </button>
                        <!-- add new part change entry button -->
                        <button class="btn btn-outline-primary btn-sm d-flex align-items-center gap-1"
                            (click)="onOpenUpsertPartChangeModal()">
                            <svg height="18" width="18" viewBox="0 0 48 48" class="flex-shrink-0">
                                <line fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="4"
                                    stroke-linecap="round" x1="8" x2="40" y1="24" y2="24" />
                                <line fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="4"
                                    stroke-linecap="round" x1="24" x2="24" y1="8" y2="40" />
                            </svg>
                            <span class="text-nowrap">
                                New Machine Part
                            </span>
                        </button>
                    </div>
                </div>
            </caption>
            <thead class="table-dark bg-opacity-50">
                <tr>
                    <th scope="col" class="w-1-percent">#</th>
                    <th scope="col" class="text-nowrap">
                        Part Name
                    </th>
                    <th scope="col">
                        Machine
                    </th>
                    <th scope="col" class="text-nowrap">
                        Changed On
                    </th>
                    <th scope="col" class="text-nowrap">
                        Changed By
                    </th>
                    <th scope="col" class="w-1-percent">
                        Action
                    </th>
                </tr>
            </thead>
            <tbody>
                @for(pceItem of filteredPartChangeList; track pceItem._id; let i=$index;){
                <tr>
                    <th scope="row">{{i+1}}</th>
                    <td class="text-capitalize">
                        {{pceItem?.partName}}
                    </td>
                    <td class="text-capitalize">
                        {{pceItem?.machineId?.machineName}} ({{pceItem?.machineId?.machineCode}})
                    </td>
                    <td class="text-capitalize">
                        {{pceItem?.changeDate|date:'dd-MM-yyyy'}}
                    </td>
                    <td class="text-capitalize">
                        <span class="lh-1 mb-1">
                            {{pceItem?.changedBy}}
                        </span>
                        @if(pceItem?.changedByContact){
                        <span class="small lh-1 text-muted">
                            ({{pceItem?.changedByContact}})
                        </span>
                        }
                    </td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm" (click)="onOpenUpsertPartChangeModal(pceItem)">
                            Edit
                        </button>
                    </td>
                </tr>
                }@empty {
                <tr>
                    <td colspan="6" class="text-muted small text-center">
                        No records found.
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>
    <!-- Pagination Component -->
    <app-pagination class="d-block" [pageSize]="pageSize" [totalEntries]="totalEntries" [currentPage]="currentPage"
        (pageChange)="onPageChange($event)" />
</div>



<!-- Create/Upsert Workspace Modal -->
@if (isUpsertPartsChangeEntryModalOpen){
<app-upsert-parts-change-entry [machineList]="machineList" [partNameList]="partsNameList"
    [pceData]="upsertPartsChangeEntryModalData" (close)="onClosePartChangeModal()"
    (upsert)="upsertPartChangeModalEvent($event)"></app-upsert-parts-change-entry>
}

<!-- Filter Modal -->
@if (toggleFilterPopup){
<div class="modal d-block">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header">
                <h1 class="modal-title fs-5">
                    Filter Machine Parts Changes
                </h1>
                <button type="button" class="btn-close" (click)="onCloseOrCancelFilterPopup()"></button>
            </div>
            <div class="modal-body">
                <app-search-input class="d-block border border-1 rounded-2 overflow-hidden mb-4"
                    [searchTerms]="cacheSearchTerm" placeholder="Search by Name or Code"
                    (onSearch)="onSearchTerms($event)"></app-search-input>

                <!-- select/deselect all -->
                <div class="d-flex align-items-center gap-2 user-select-none mb-3">
                    <input class="form-check-input m-0 fs-4" type="checkbox" id="selectAllMachines"
                        [checked]="isAllFilterSelected" (click)="onToggleSelectAllFilters()" />
                    <label class="form-check-label w-100" for="selectAllMachines">
                        <span class="text-capitalize text-dark">
                            Select / Deselect All
                        </span>
                    </label>
                </div>

                <div class="overflow-auto adjust-list-wrap d-flex flex-wrap gap-2">
                    @for (machine of filteredFilterPartChangeList; track i; let i = $index) {
                    <div class="d-flex align-items-center gap-2 user-select-none">
                        <input class="form-check-input m-0 fs-5" type="checkbox" [id]="machine._id+i"
                            [checked]="machine.selected" [(ngModel)]="machine.selected"
                            (ngModelChange)="onFilterSelectionChange()" />
                        <label class="form-check-label w-100" [for]="machine._id+i">
                            <span class="text-capitalize text-dark">
                                {{ machine?.machineCode }} - {{ machine?.machineName }}
                            </span>
                        </label>
                    </div>
                    }@empty {
                    <div class="flex-grow-1 text-center text-muted small">
                        {{cacheSearchTerm ? 'No matches found for the search term.' :
                        'No machines available to filter.'}}
                    </div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary me-3" (click)="onCloseOrCancelFilterPopup()">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" (click)="onApplyFilterPopup()">
                    Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>
}